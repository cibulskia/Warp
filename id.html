<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Warp Connect - Demo</title>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Uključi oath.js (OAuth + backend komunikacija) -->
    <script src="oath.js" defer></script>

    <style>
        /* Jednostavan moderni stil - možeš prilagoditi */
        :root {
            --bg: #f5f7fb;
            --card: #ffffff;
            --muted: #6b7280;
            --accent: #2563eb;
            --danger: #dc2626;
        }
        html,body { height:100%; margin:0; font-family: Inter, Roboto, Arial, sans-serif; background: var(--bg); color:#111827; }
        .container { max-width: 1100px; margin: 30px auto; padding: 20px; }
        header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; }
        .brand { display:flex; gap:12px; align-items:center; }
        .logo { width:48px; height:48px; border-radius:8px; background:linear-gradient(135deg,#60a5fa,#7c3aed); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; }
        .controls { display:flex; gap:8px; align-items:center; }

        .grid { display:grid; grid-template-columns: 300px 1fr; gap:16px; }
        .card { background:var(--card); border-radius:12px; padding:12px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
        #subcategory-sidebar { display:flex; flex-direction:column; gap:8px; }
        #subcategory-list { display:flex; flex-direction:column; gap:6px; max-height:420px; overflow:auto; padding:6px; }
        .subcategory-list-item { padding:8px 10px; border-radius:8px; cursor:pointer; border:1px solid transparent; }
        .subcategory-list-item:hover { background:#f3f4f6; }
        .subcategory-list-item.selected { background:#eef2ff; border-color:#c7d2fe; }

        #app-content { display:none; } /* prikazuje se nakon login-a */

        .row { display:flex; gap:8px; align-items:center; }
        .muted { color:var(--muted); font-size:0.9rem; }
        button { cursor:pointer; border: none; padding:8px 10px; border-radius:8px; background:var(--accent); color:white; }
        button.ghost { background:transparent; color:var(--accent); border:1px solid #e6eefc; }
        input, textarea, select { padding:8px; border-radius:8px; border:1px solid #e6e9ef; width:100%; box-sizing:border-box; }
        .small { font-size:0.85rem; padding:6px 8px; border-radius:6px; }
        #spreadsheet-content { min-height:120px; padding:8px; background:#fafafa; border-radius:8px; border:1px dashed #e6e9ef; }

        /* Profil */
        .profile { display:flex; gap:8px; align-items:center; }
        .profile img { width:36px; height:36px; border-radius:50%; object-fit:cover; }

        /* Forma potkategorije */
        #subcategory-form { display:none; margin-top:8px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="brand">
                <div class="logo">W</div>
                <div>
                    <div style="font-weight:700">Warp Connect</div>
                    <div class="muted" style="font-size:0.85rem">Platforma za poslove i postavke — demo</div>
                </div>
            </div>

            <div class="controls">
                <div id="g_id_onload" style="display:block;">
                    <!-- mesto za Google button -->
                    <div id="g_id_signin_button"></div>
                </div>

                <div id="auth-area" style="display:flex; gap:8px; align-items:center;">
                    <div class="profile">
                        <img id="profile-picture" src="" alt="profile" style="display:none">
                        <div id="profile-picture-placeholder" style="width:36px; height:36px; border-radius:50%; background:#e5e7eb; display:flex; align-items:center; justify-content:center;">?</div>
                    </div>
                    <div id="user-name" class="muted"></div>
                    <button id="signout-button" class="ghost" style="display:inline-block;">Odjavi se</button>
                </div>
            </div>
        </header>

        <div class="grid">
            <!-- SIDEBAR -->
            <aside id="subcategory-sidebar" class="card" style="display:none;">
                <div class="row" style="justify-content:space-between; align-items:center;">
                    <div style="font-weight:600">Potkategorije</div>
                    <div style="display:flex; gap:6px;">
                        <button id="create-subcategory-button" class="small ghost">Nova</button>
                        <button id="load-subcategories-button" class="small">Učitaj listu</button>
                    </div>
                </div>

                <div id="subcategory-message" class="muted"></div>

                <div id="subcategory-list"></div>

                <div id="subcategory-form" class="card">
                    <div style="font-weight:600">Uredi potkategoriju</div>
                    <div style="margin-top:8px;">
                        <input id="subcategory-name" placeholder="Ime potkategorije" />
                        <input id="subcategory-short-desc" placeholder="Kratak opis" style="margin-top:8px;" />
                        <textarea id="subcategory-long-desc" placeholder="Dugačak opis" style="margin-top:8px; height:80px;"></textarea>
                        <label class="row" style="margin-top:8px;">
                            <input id="subcategory-checkbox" type="checkbox" /> &nbsp; Aktivan
                        </label>
                        <div style="display:flex; gap:8px; margin-top:8px;">
                            <button id="save-subcategory-button">Sačuvaj</button>
                            <button id="cancel-subcategory-edit-button" class="ghost">Otkaži</button>
                            <button id="delete-subcategory-button" class="ghost" style="color:var(--danger); border-color:transparent;">Obriši</button>
                        </div>
                    </div>
                </div>

            </aside>

            <!-- MAIN -->
            <main>
                <div id="app-content" class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700">Dobrodošli, <span id="user-name-display"></span></div>
                            <div class="muted" id="message">Molimo prijavite se putem Google-a.</div>
                        </div>

                        <div>
                            <button id="save-button" class="small">Sačuvaj</button>
                            <button id="load-button" class="small ghost">Učitaj</button>
                        </div>
                    </div>

                    <hr style="margin:12px 0; border:none; border-top:1px solid #eef2ff;">

                    <div style="display:flex; gap:12px;">
                        <div style="flex:1;">
                            <div style="font-weight:600; margin-bottom:8px;">Spreadsheet podaci</div>
                            <div id="spreadsheet-content">Nema podataka učitanih.</div>
                        </div>

                        <div style="width:320px;">
                            <div style="font-weight:600; margin-bottom:8px;">Trenutna potkategorija: <span id="current-subcategory-id">Nijedna</span></div>
                            <textarea id="large-text-input" placeholder="Veliki unos..." style="height:140px;"></textarea>
                        </div>
                    </div>
                </div>

                <div style="margin-top:12px;" class="muted">Tip: nakon prijave, klikni "Učitaj listu" da dobiješ potkategorije sa backend-a.</div>
            </main>
        </div>
    </div>

    <script>
    /* ===========================
       UI & client-side logic (ostatak koda)
       =========================== */

    // SPREADSHEET URL (isti kao u originalu)
    const SPREADSHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vToqj0JglDOwG_PdfpqiBTA76JnJO9AY38FNnpudB_YevYjhriY6oZbthJeUfqbkPbOdDxf8Aa4R9__/pub?gid=1502637795&single=true&output=csv";
    let spreadsheetData = [];

    async function fetchSpreadsheetData() {
        try {
            const response = await fetch(SPREADSHEET_URL);
            const csvText = await response.text();
            spreadsheetData = parseCSV(csvText);
            console.log("Spreadsheet data loaded:", spreadsheetData);
        } catch (error) {
            console.error("Error fetching or parsing spreadsheet data:", error);
            document.getElementById('spreadsheet-content').innerHTML = '<p style="color: red;">Greška pri učitavanju podataka iz spreadsheeta.</p>';
        }
    }

    function parseCSV(csv) {
        const lines = csv.split('\n');
        const data = [];
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line) {
                // jednostavan split, neće raditi sa quoted commas
                data.push(line.split(',').map(cell => cell.trim()));
            }
        }
        return data;
    }

    function displaySpreadsheetDataFromDOMSubcategories() {
        const spreadsheetContentDiv = document.getElementById('spreadsheet-content');
        spreadsheetContentDiv.innerHTML = ''; // Clear previous content

        if (spreadsheetData.length === 0) {
            spreadsheetContentDiv.innerHTML = '<p>Nema dostupnih podataka iz spreadsheeta ili još nisu učitani.</p>';
            return;
        }

        const subcategoryListItems = document.querySelectorAll('#subcategory-list .subcategory-list-item');
        let foundData = false;

        if (subcategoryListItems.length === 0) {
            spreadsheetContentDiv.innerHTML = '<p>Nema učitanih potkategorija za prikaz podataka iz spreadsheeta.</p>';
            return;
        }

        subcategoryListItems.forEach(item => {
            const subcategoryName = item.textContent.trim(); // Get subcategory name from the list item text
            const rowNumber = parseInt(subcategoryName, 10); // Try to parse as a row number

            if (!isNaN(rowNumber) && rowNumber > 0 && rowNumber <= spreadsheetData.length) {
                const rowData = spreadsheetData[rowNumber - 1]; // Adjust for 0-based indexing
                if (rowData) {
                    foundData = true;
                    const dataHtml = `
                        <div class="spreadsheet-data-item">
                            <p>${rowData.join('<br>')}</p>
                        </div>
                    `;
                    spreadsheetContentDiv.innerHTML += dataHtml;
                }
            }
        });

        if (!foundData) {
            spreadsheetContentDiv.innerHTML = '<p>Nije pronađen nijedan red u spreadsheetu koji odgovara imenu potkategorije.</p>';
        }
    }

    /* ====== UI funkcije koje oath.js očekuje da postoje ====== */
    function updateUIForLoggedInUser(userName, userProfilePicUrl) {
        document.getElementById('g_id_onload').style.display = 'none';
        document.querySelector('.g_id_signin')?.style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        document.getElementById('subcategory-sidebar').style.display = 'flex';
        document.getElementById('user-name').textContent = userName;
        document.getElementById('user-name-display').textContent = userName;
        document.getElementById('message').textContent = "";
        document.getElementById('subcategory-message').textContent = "";

        const profilePicElement = document.getElementById('profile-picture');
        const profilePicPlaceholder = document.getElementById('profile-picture-placeholder');
        if (userProfilePicUrl) {
            profilePicElement.src = userProfilePicUrl;
            profilePicElement.style.display = 'block';
            profilePicPlaceholder.style.display = 'none';
        } else {
            profilePicElement.style.display = 'none';
            profilePicPlaceholder.style.display = 'block';
        }

        document.getElementById('input1')?.value = "";
        document.getElementById('input2')?.value = "";
        document.getElementById('large-text-input').value = "";
        document.getElementById('input3')?.value = "";
        document.getElementById('input4')?.value = "";
        document.getElementById('input5')?.value = "";
        document.getElementById('dropdown-input')?.value = "";
        document.getElementById('sidebar-large-text-input-2')?.value = "";
        document.getElementById('sidebar-large-text-input-3')?.value = "";

        document.getElementById('subcategory-form').style.display = 'none';
        if (window.setCurrentSubcategoryId) window.setCurrentSubcategoryId(null);
        document.getElementById('current-subcategory-id').textContent = "Nijedna";
        clearSubcategoryForm();
        document.querySelectorAll('.subcategory-list-item').forEach(item => item.classList.remove('selected'));

        // Load spreadsheet data and then initiate subcategory loading
        fetchSpreadsheetData().then(() => {
            if (window.loadSubcategoriesFromBackend) {
                window.loadSubcategoriesFromBackend(false).then(() => {
                    // after backend populates #subcategory-list we try to match and display spreadsheet
                    setTimeout(displaySpreadsheetDataFromDOMSubcategories, 150);
                }).catch(err => {
                    console.warn("loadSubcategoriesFromBackend vratio grešku:", err);
                    displaySpreadsheetDataFromDOMSubcategories();
                });
            } else {
                displaySpreadsheetDataFromDOMSubcategories();
            }
        });
    }

    function updateUIForLoggedOutUser() {
        document.getElementById('g_id_onload').style.display = 'block';
        document.querySelector('.g_id_signin')?.style.display = 'block';
        document.getElementById('app-content').style.display = 'none';
        document.getElementById('subcategory-sidebar').style.display = 'none';
        document.getElementById('user-name').textContent = "";
        document.getElementById('message').textContent = "Molimo prijavite se putem Google-a.";
        document.getElementById('subcategory-message').textContent = "";
        if (window.setCurrentSubcategoryId) window.setCurrentSubcategoryId(null);
        document.cookie = "session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        document.getElementById('subcategory-list').innerHTML = '';
        document.getElementById('spreadsheet-content').innerHTML = ''; // Clear spreadsheet data

        document.getElementById('profile-picture').style.display = 'none';
        document.getElementById('profile-picture-placeholder').style.display = 'block';
        document.getElementById('profile-picture').src = '';
    }

    window.updateUIForLoggedInUser = updateUIForLoggedInUser;
    window.updateUIForLoggedOutUser = updateUIForLoggedOutUser;

    /* ====== Subcategory form helpers ====== */
    function clearSubcategoryForm() {
        document.getElementById('subcategory-name').value = '';
        document.getElementById('subcategory-short-desc').value = '';
        document.getElementById('subcategory-long-desc').value = '';
        document.getElementById('subcategory-checkbox').checked = false;
    }
    window.clearSubcategoryForm = clearSubcategoryForm;

    function showSubcategoryForm(subcategory = {}) {
        document.getElementById('subcategory-form').style.display = 'block';
        if (window.setCurrentSubcategoryId) window.setCurrentSubcategoryId(subcategory.id);
        document.getElementById('current-subcategory-id').textContent = subcategory.id || 'Nijedna';
        document.getElementById('subcategory-name').value = subcategory.name || '';
        document.getElementById('subcategory-short-desc').value = subcategory.short_description || '';
        document.getElementById('subcategory-long-desc').value = subcategory.long_description || '';
        document.getElementById('subcategory-checkbox').checked = subcategory.is_active || false;
    }
    window.showSubcategoryForm = showSubcategoryForm;

    /* ====== Render list helper (može ga overrid-ovati oath.js) ====== */
    function renderSubcategoryList(list = [], reselect = false) {
        const container = document.getElementById('subcategory-list');
        container.innerHTML = '';
        list.forEach(s => {
            const li = document.createElement('div');
            li.className = 'subcategory-list-item';
            li.dataset.id = s.id;
            li.textContent = s.name || String(s.id || "");
            li.addEventListener('click', () => {
                selectSubcategory(s.id);
            });
            container.appendChild(li);
        });

        if (reselect && window.getCurrentSubcategoryId) {
            const id = window.getCurrentSubcategoryId();
            if (id) selectSubcategory(id);
        }
    }
    window.renderSubcategoryList = renderSubcategoryList;

    /* ====== Select subcategory ====== */
    function selectSubcategory(subcategoryId) {
        document.querySelectorAll('.subcategory-list-item').forEach(item => {
            item.classList.remove('selected');
        });

        const selectedItem = document.querySelector(`.subcategory-list-item[data-id="${subcategoryId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('selected');
            if (window.loadSubcategoryDetailsFromBackend) {
                window.loadSubcategoryDetailsFromBackend(subcategoryId);
            } else {
                // fallback: samo prikaži ID
                if (window.setCurrentSubcategoryId) window.setCurrentSubcategoryId(subcategoryId);
                document.getElementById('current-subcategory-id').textContent = subcategoryId;
            }
        }
    }
    window.selectSubcategory = selectSubcategory;

    /* ====== Event listeners (već spomenuti u originalnom kodu) ====== */
    window.addEventListener('load', () => {
        // inicijalno stanje
        updateUIForLoggedOutUser();

        // inicijalizacija GSI - oauth.js sadrži window.initGSI
        // čekamo da oath.js bude učitan; initGSI će proveriti google objekat
        if (window.initGSI) {
            // delay malo da se google script učita (script je async defer)
            setTimeout(() => {
                try {
                    window.initGSI();
                } catch (e) {
                    console.warn("initGSI bacio grešku:", e);
                }
            }, 300);
        }
    });

    // Dugmad i akcije
    document.getElementById('save-button').addEventListener('click', () => {
        if (window.saveMainData) window.saveMainData();
    });
    document.getElementById('load-button').addEventListener('click', () => {
        if (window.loadMainData) window.loadMainData();
    });
    document.getElementById('signout-button').addEventListener('click', () => {
        if (window.signOutUser) window.signOutUser();
    });

    document.getElementById('create-subcategory-button').addEventListener('click', () => {
        // provera login stanja (jednostavno: sakriveni g_id_onload)
        if (!document.getElementById('g_id_onload') || document.getElementById('g_id_onload').style.display !== 'none') {
            alert("Niste prijavljeni.");
            return;
        }
        clearSubcategoryForm();
        showSubcategoryForm({ id: 'Nova' });
        document.getElementById('subcategory-message').textContent = "Unesite detalje za novu potkategoriju.";
        if (window.setCurrentSubcategoryId) window.setCurrentSubcategoryId(null);
        document.getElementById('current-subcategory-id').textContent = "Nova";
    });

    document.getElementById('save-subcategory-button').addEventListener('click', () => {
        const subcategoryData = {
            name: document.getElementById('subcategory-name').value,
            short_description: document.getElementById('subcategory-short-desc').value,
            long_description: document.getElementById('subcategory-long-desc').value,
            is_active: document.getElementById('subcategory-checkbox').checked
        };
        const currentSubcategoryId = (window.getCurrentSubcategoryId) ? window.getCurrentSubcategoryId() : null;
        const isNew = (!currentSubcategoryId || currentSubcategoryId === 'Nova');
        if (window.saveSubcategory) window.saveSubcategory(subcategoryData, isNew, isNew ? null : currentSubcategoryId);
    });

    document.getElementById('delete-subcategory-button').addEventListener('click', () => {
        const currentSubcategoryId = (window.getCurrentSubcategoryId) ? window.getCurrentSubcategoryId() : null;
        if (window.deleteSubcategory) window.deleteSubcategory(currentSubcategoryId);
    });

    document.getElementById('load-subcategories-button').addEventListener('click', () => {
        if (window.loadSubcategoriesFromBackend) {
            window.loadSubcategoriesFromBackend(false).then(list => {
                // Nakon što je lista renderovana, pokušaj prikazati spreadsheet data
                setTimeout(displaySpreadsheetDataFromDOMSubcategories, 150);
            }).catch(err => {
                console.warn("loadSubcategoriesFromBackend vratio grešku:", err);
                displaySpreadsheetDataFromDOMSubcategories();
            });
        } else {
            console.warn("Could not find subcategory loading function in oath.js. Displaying spreadsheet data directly if possible.");
            displaySpreadsheetDataFromDOMSubcategories();
        }
    });

    document.getElementById('cancel-subcategory-edit-button').addEventListener('click', () => {
        document.getElementById('subcategory-form').style.display = 'none';
        clearSubcategoryForm();
        if (window.setCurrentSubcategoryId) window.setCurrentSubcategoryId(null);
        document.getElementById('current-subcategory-id').textContent = "Nijedna";
        document.getElementById('subcategory-message').textContent = "";
    });

    </script>
</body>
</html>
