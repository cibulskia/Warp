<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google OAuth App with Profile</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
body { font-family: Arial,sans-serif; display:flex; justify-content:center; align-items:center; min-height:100vh; background:#f4f4f4; margin:0; }
.container { background:#fff; padding:30px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); width:450px; text-align:center; }
h1 { color:#333; margin-bottom:20px; }
input[type="text"], select { width: calc(100% - 20px); padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px; font-size:16px; }
button { background:#007bff; color:white; padding:10px 15px; border:none; border-radius:4px; cursor:pointer; font-size:16px; margin:5px; }
button:hover { background:#0056b3; }
#signout-button { background:#dc3545; }
#signout-button:hover { background:#c82333; }
#message { margin-top:10px; color:#333; }
#profile-preview { max-width:100px; margin-bottom:10px; border-radius:50%; }
</style>
</head>
<body>
<div class="container">
    <h1>Moja Aplikacija</h1>

    <div id="g_id_onload"
         data-client_id="252373158568-4up41b7jo8ik6cu8c1pl3mlvvck2sq2t.apps.googleusercontent.com"
         data-auto_select="true"
         data-callback="handleCredentialResponse"
         data-ux_mode="popup"
         data-cancel_on_tap_outside="false"
         data-context="use">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>

    <div id="app-content" style="display:none;">
        <p>Dobrodošao, <span id="user-name"></span>!</p>
        <img id="profile-preview" src="" alt="Profilna slika">
        <input type="file" id="profile-image-input" accept="image/*">
        <input type="text" id="field1" placeholder="Polje 1">
        <input type="text" id="field2" placeholder="Polje 2">
        <input type="text" id="field3" placeholder="Polje 3">
        <input type="text" id="field4" placeholder="Polje 4">
        <input type="text" id="field5" placeholder="Polje 5">
        <select id="dropdown-option">
            <option value="">Izaberite opciju</option>
            <option value="Opcija1">Opcija 1</option>
            <option value="Opcija2">Opcija 2</option>
            <option value="Opcija3">Opcija 3</option>
        </select>
        <br>
        <button id="save-button">Sačuvaj Podatke</button>
        <button id="load-button">Učitaj Podatke</button>
        <p id="message"></p>
        <button id="signout-button">Odjavi se</button>
    </div>
</div>

<script>
const BACKEND_URL = 'https://botanica.ngrok.app';
let googleIdToken = null;
let userName = null;
let profileImageBase64 = null;

function handleCredentialResponse(response) {
    googleIdToken = response.credential;
    fetch(`${BACKEND_URL}/verify-google-login`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id_token: googleIdToken})
    }).then(r=>r.json())
      .then(data=>{
        if(data.status==='success'){
            userName = data.user_name;
            updateUIForLoggedInUser();
        } else { googleIdToken=null; userName=null; updateUIForLoggedOutUser(); alert(data.message);}
      });
}

function updateUIForLoggedInUser(){
    document.getElementById('g_id_onload').style.display='none';
    document.querySelector('.g_id_signin').style.display='none';
    document.getElementById('app-content').style.display='block';
    document.getElementById('user-name').textContent=userName;
    document.getElementById('message').textContent='';
    document.getElementById('profile-preview').src='';
}

function updateUIForLoggedOutUser(){
    document.getElementById('g_id_onload').style.display='block';
    document.querySelector('.g_id_signin').style.display='block';
    document.getElementById('app-content').style.display='none';
    document.getElementById('user-name').textContent='';
    document.getElementById('message').textContent='Molimo prijavite se putem Google-a.';
    googleIdToken=null; userName=null; profileImageBase64=null;
    document.cookie="session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
}

window.onload = updateUIForLoggedOutUser;

document.getElementById('profile-image-input').addEventListener('change', function(e){
    const file = e.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = function(evt){
            profileImageBase64 = evt.target.result;
            document.getElementById('profile-preview').src = profileImageBase64;
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('save-button').addEventListener('click', ()=>{
    if(!googleIdToken){ alert("Niste prijavljeni."); return; }
    const data = {
        profile_image: profileImageBase64,
        field1: document.getElementById('field1').value,
        field2: document.getElementById('field2').value,
        field3: document.getElementById('field3').value,
        field4: document.getElementById('field4').value,
        field5: document.getElementById('field5').value,
        dropdown_option: document.getElementById('dropdown-option').value
    };
    fetch(`${BACKEND_URL}/save-data`, {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${googleIdToken}`},
        body: JSON.stringify(data)
    }).then(r=>r.json())
      .then(res=>{
        document.getElementById('message').textContent = res.message;
      }).catch(err=>{ console.error(err); document.getElementById('message').textContent='Greška prilikom čuvanja podataka.'; });
});

document.getElementById('load-button').addEventListener('click', ()=>{
    if(!googleIdToken){ alert("Niste prijavljeni."); return; }
    fetch(`${BACKEND_URL}/load-data`, {method:'GET', headers:{'Authorization':`Bearer ${googleIdToken}`}})
        .then(r=>r.json())
        .then(res=>{
            if(res.status==='success' && res.data){
                const d=res.data;
                document.getElementById('field1').value=d.field1||'';
                document.getElementById('field2').value=d.field2||'';
                document.getElementById('field3').value=d.field3||'';
                document.getElementById('field4').value=d.field4||'';
                document.getElementById('field5').value=d.field5||'';
                document.getElementById('dropdown-option').value=d.dropdown_option||'';
                if(d.profile_image){
                    profileImageBase64=d.profile_image;
                    document.getElementById('profile-preview').src=profileImageBase64;
                }
                document.getElementById('message').textContent=res.message;
            } else { document.getElementById('message').textContent=res.message; }
        }).catch(err=>{ console.error(err); document.getElementById('message').textContent='Greška prilikom učitavanja podataka.'; });
});

document.getElementById('signout-button').addEventListener('click', ()=>{
    googleIdToken=null; userName=null; profileImageBase64=null;
    updateUIForLoggedOutUser();
    fetch(`${BACKEND_URL}/logout`,{method:'POST', headers:{'Content-Type':'application/json'}})
        .then(r=>r.json()).then(data=>alert(data.message)).catch(err=>{console.error(err); alert('Greška prilikom odjave.');});
});
</script>
</body>
</html>
