<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Google OAuth App (All in One)</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
body{font-family:Arial,sans-serif;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;background-color:#f4f4f4;margin:0;padding:20px;}
.container{background-color:#fff;padding:30px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);text-align:center;width:420px;margin-bottom:20px;}
h1{color:#333;margin-bottom:20px}
input[type="text"]{width:calc(100% - 22px);padding:10px;margin-bottom:12px;border:1px solid #ddd;border-radius:4px;font-size:16px}
button{background-color:#007bff;color:white;padding:10px 15px;border:none;border-radius:4px;cursor:pointer;font-size:16px;margin:5px}
button:hover{background-color:#0056b3}
#message{margin-top:14px;color:#333}
#user-name{font-weight:bold;color:#007bff}
#signout-button{background-color:#dc3545}
#signout-button:hover{background-color:#c82333}
.profile-img{width:120px;height:120px;border-radius:999px;object-fit:cover;border:2px solid #eee;margin:10px 0}
.file-row{display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;margin-top:10px}
.file-row input[type="file"]{padding:6px;border-radius:4px;border:1px solid #ddd;cursor:pointer}
.file-row button{width:160px}
.small{font-size:14px}

/* Nova sekcija za listu slika */
#image-list-container{margin-top:30px;text-align:left}
#image-list-container h2{font-size:20px;margin-bottom:12px;color:#333;}
.image-placeholder{width:100%;height:auto;margin-bottom:10px;}
.image-item{border-bottom:1px solid #ddd;padding:10px 0;display:flex;flex-direction:column;}
.image-item img{width:100%;height:auto;border-radius:6px;margin-bottom:4px;}
.image-item .image-title{font-weight:bold;color:#007bff;font-size:16px;margin-bottom:2px;}
.image-item .image-desc{font-size:14px;color:#555;}
#image-list{max-height:300px;overflow-y:auto;padding-right:4px;}
</style>
</head>
<body>
<div class="container">
<h1>Moja Aplikacija</h1>
<div id="g_id_onload"
data-client_id="252373158568-4up41b7jo8ik6cu8c1pl3mlvvck2sq2t.apps.googleusercontent.com"
data-auto_select="true"
data-callback="handleCredentialResponse"
data-ux_mode="popup"
data-cancel_on_tap_outside="false"
data-context="use">
</div>
<div class="g_id_signin"
data-type="standard"
data-size="large"
data-theme="outline"
data-text="sign_in_with"
data-shape="rectangular"
data-logo_alignment="left">
</div>
<div id="app-content" style="display:none">
<p>Dobrodošao, <span id="user-name"></span>!</p>
<img id="profile-image" class="profile-img" src="" alt="Profilna slika" style="display:none"/>
<div>
<input type="text" id="data-input" placeholder="Unesi tekst ovde..." />
</div>
<div style="margin-top:8px">
<button id="save-button">Sačuvaj Podatke</button>
<button id="load-button">Učitaj Podatke</button>
</div>
<div class="file-row">
<input type="file" id="image-file" accept="image/*"/>
<button id="upload-button">Otpremi Profilnu</button>
</div>
<p id="message"></p>
<button id="signout-button">Odjavi se</button>

<!-- Nova sekcija za listu slika -->
<div id="image-list-container">
<h2>Galerija Slika</h2>
<!-- Prikaz placeholder slike -->
<div id="placeholder">
<img class="image-placeholder" src="https://i.ibb.co/0Vr8smLT/669a560280d3.png" alt="Placeholder">
<p class="image-title">Placeholder naslov</p>
<p class="image-desc">Placeholder objašnjenje slike.</p>
</div>
<div id="image-list"></div>
</div>
</div>

<script>
const BACKEND_URL = 'https://botanica.ngrok.app';
let googleIdToken = null;
let userName = null;

function handleCredentialResponse(response){
    googleIdToken = response.credential;
    fetch(`${BACKEND_URL}/verify-google-login`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id_token:googleIdToken})
    })
    .then(res=>{if(!res.ok)throw res;return res.json()})
    .then(data=>{
        if(data.status==='success'){userName=data.user_name;updateUIForLoggedInUser()}
        else{googleIdToken=null;userName=null;updateUIForLoggedOutUser();alert('Login failed: '+(data.message||''))}
    })
    .catch(err=>{googleIdToken=null;userName=null;updateUIForLoggedOutUser();alert('Greška pri prijavi')});
}

function updateUIForLoggedInUser(){
    document.getElementById('g_id_onload').style.display='none';
    document.querySelector('.g_id_signin').style.display='none';
    document.getElementById('app-content').style.display='block';
    document.getElementById('user-name').textContent=userName||'';
    document.getElementById('message').textContent='';
    document.getElementById('data-input').value='';
    document.getElementById('profile-image').style.display='none';
    document.getElementById('profile-image').src='';
}

function updateUIForLoggedOutUser(){
    document.getElementById('g_id_onload').style.display='block';
    document.querySelector('.g_id_signin').style.display='block';
    document.getElementById('app-content').style.display='none';
    document.getElementById('user-name').textContent='';
    document.getElementById('message').textContent='Molimo prijavite se putem Google-a.';
    googleIdToken=null;userName=null;
    document.cookie = "session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
}

window.onload=function(){
    updateUIForLoggedOutUser();
    loadImageList();
};

// Čuvanje i učitavanje podataka
document.getElementById('save-button').addEventListener('click',()=>{
    const textData=document.getElementById('data-input').value;
    if(!googleIdToken){alert('Niste prijavljeni. Molimo prijavite se putem Google-a.');return}
    fetch(`${BACKEND_URL}/save-data`,{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${googleIdToken}`},
        body:JSON.stringify({data:textData})
    })
    .then(res=>{if(!res.ok){if(res.status===401){alert('Vaša sesija je istekla. Molimo prijavite se ponovo.');updateUIForLoggedOutUser()}throw res}return res.json()})
    .then(data=>{document.getElementById('message').textContent=data.message})
    .catch(()=>{document.getElementById('message').textContent='Greška prilikom čuvanja podataka.'});
});

document.getElementById('load-button').addEventListener('click',()=>{
    if(!googleIdToken){alert('Niste prijavljeni. Molimo prijavite se putem Google-a.');return}
    fetch(`${BACKEND_URL}/load-data`,{
        method:'GET',
        headers:{'Authorization':`Bearer ${googleIdToken}`}
    })
    .then(res=>{if(!res.ok){if(res.status===401){alert('Vaša sesija je istekla. Molimo prijavite se ponovo.');updateUIForLoggedOutUser()}throw res}return res.json()})
    .then(data=>{
        document.getElementById('data-input').value=data.data||'';
        document.getElementById('message').textContent=data.message||'';
        if(data.image_url){
            document.getElementById('profile-image').src=data.image_url;
            document.getElementById('profile-image').style.display='block';
        } else { document.getElementById('profile-image').style.display='none' }
    })
    .catch(()=>{document.getElementById('message').textContent='Greška prilikom učitavanja podataka.'});
});

document.getElementById('upload-button').addEventListener('click',()=>{
    const fileInput=document.getElementById('image-file');
    const file=fileInput.files[0];
    if(!file){alert('Izaberite sliku pre otpremanja.');return}
    if(!googleIdToken){alert('Niste prijavljeni. Molimo prijavite se putem Google-a.');return}
    const form=new FormData();
    form.append('image',file);
    fetch(`${BACKEND_URL}/upload-image`,{
        method:'POST',
        headers:{'Authorization':`Bearer ${googleIdToken}`},
        body:form
    })
    .then(res=>{if(!res.ok){if(res.status===401){alert('Vaša sesija je istekla. Molimo prijavite se ponovo.');updateUIForLoggedOutUser()}throw res}return res.json()})
    .then(data=>{
        if(data.status==='success'){
            document.getElementById('profile-image').src=data.image_url;
            document.getElementById('profile-image').style.display='block';
            document.getElementById('message').textContent='Slika uspešno otpremljena i povezana sa profilom.';
            document.getElementById('image-file').value='';
        } else {document.getElementById('message').textContent='Greška pri otpremanju slike.'}
    })
    .catch(()=>{document.getElementById('message').textContent='Greška pri otpremanju slike.'});
});

document.getElementById('signout-button').addEventListener('click',()=>{
    googleIdToken=null;userName=null;updateUIForLoggedOutUser();
    fetch(`${BACKEND_URL}/logout`,{method:'POST',headers:{'Content-Type':'application/json'}})
    .then(res=>res.json()).then(()=>{alert('Uspešno ste se odjavili.')}).catch(()=>{alert('Došlo je do greške prilikom odjave sa servera.')});
});

// Nova funkcija za listu slika
function loadImageList(){
    fetch('images.json')
    .then(res=>res.json())
    .then(data=>{
        const container = document.getElementById('image-list');
        data.forEach(imgTagStr=>{
            // Privremeno kreiramo div da parsiramo img tag
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = imgTagStr;
            const img = tempDiv.querySelector('img');
            if(img){
                // Koristimo imgbb alt kao ime, a početak linka kao objašnjenje (primer)
                const src = img.src;
                const alt = img.alt || 'Slika';
                const desc = src.substring(src.lastIndexOf('/')+1);
                const itemDiv = document.createElement('div');
                itemDiv.className='image-item';
                itemDiv.innerHTML=`<img src="${src}" alt="${alt}"><p class="image-title">${alt}</p><p class="image-desc">${desc}</p>`;
                container.appendChild(itemDiv);
            }
        });
    })
    .catch(err=>console.log('Greška pri učitavanju liste slika',err));
}
</script>
</body>
</html>
